<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yêu Cầu Trả Hàng/Hoàn Tiền - E-Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/user.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Yêu Cầu Trả Hàng/Hoàn Tiền</h1>
                <p class="text-gray-600">Vui lòng cung cấp thông tin chi tiết về yêu cầu của bạn</p>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Chọn lý do</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-label">Mô tả chi tiết</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Xác nhận</div>
                </div>
            </div>
            
            <!-- Section 1: Situation -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Tình huống bạn đang gặp?</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Reason Cards -->
                    <div class="reason-card bg-white rounded-lg border p-4 cursor-pointer" data-reason="damaged">
                        <div class="flex items-center">
                            <i class="fas fa-box-open text-red-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-medium">Tôi đã nhận hàng nhưng hàng có vấn đề</h3>
                                <p class="text-sm text-gray-500">(bể vỡ, sai mẫu, hàng lỗi, khác mô tả...)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="reason-card bg-white rounded-lg border p-4 cursor-pointer" data-reason="missing">
                        <div class="flex items-center">
                            <i class="fas fa-boxes text-orange-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-medium">Thiếu hàng</h3>
                                <p class="text-sm text-gray-500">(số lượng không đủ, thiếu phụ kiện...)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="reason-card bg-white rounded-lg border p-4 cursor-pointer" data-reason="wrong">
                        <div class="flex items-center">
                            <i class="fas fa-exchange-alt text-blue-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-medium">Người bán gửi sai hàng</h3>
                                <p class="text-sm text-gray-500">(sản phẩm không giống như mô tả)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="reason-card bg-white rounded-lg border p-4 cursor-pointer" data-reason="expired">
                        <div class="flex items-center">
                            <i class="fas fa-hourglass-end text-purple-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-medium">Hàng hết hạn sử dụng</h3>
                                <p class="text-sm text-gray-500">(hạn sử dụng đã qua hoặc sắp hết)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: Product Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sản phẩm đã chọn</h2>
                <div class="product-card">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-gray-200 border-2 border-dashed rounded-xl mr-4"></div>
                        <div class="flex-1">
                            <h3 class="font-semibold">Trà Đông Trùng Hạ Thảo Long Nhân Tử Vĩ An Nhiều, bổ sức khỏe, sinh lý, Nguyên liệu tự nhiên, sạch kinh</h3>
                            <div class="text-gray-600 mt-1">
                                <span>Hộp 29 gói</span>
                                <span class="mx-2">|</span>
                                <span class="font-medium">206.006₫</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 3: Return Details -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chọn sản phẩm cần Trả hàng và Hoàn tiền</h2>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gray-200 border-2 border-dashed rounded-xl mr-3"></div>
                        <div>
                            <h3 class="font-medium">Trà Đông Trùng Hạ Thảo</h3>
                            <div class="text-gray-600">Số lượng: 1</div>
                        </div>
                    </div>
                    
                    <!-- Reason Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2 required">Lý do</label>
                        <select id="reason-select" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-200">
                            <option value="">-- Chọn lý do --</option>
                            <option value="damaged">Hàng bị hư hỏng</option>
                            <option value="missing">Thiếu hàng</option>
                            <option value="wrong">Người bán gửi sai hàng</option>
                            <option value="expired">Hàng hết hạn sử dụng</option>
                            <option value="other">Lý do khác</option>
                        </select>
                    </div>
                    
                    <!-- Solution Section -->
                    <div id="solution-section" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2 required">Phương án</label>
                        <div class="text-gray-500 italic">Vui lòng chọn lý do để xem phương án</div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2 required">Mô tả</label>
                        <textarea 
                            class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-200" 
                            rows="4" 
                            placeholder="Chi tiết vấn đề bạn gặp phải"></textarea>
                    </div>
                    
                    <!-- Image Upload Section -->
                    <div class="upload-section">
                        <div class="upload-section-title">Đăng tải hình ảnh</div>
                        <div class="file-upload" id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Kéo thả hình ảnh vào đây hoặc nhấn để chọn</p>
                            <input type="file" id="image-upload" accept="image/*" multiple>
                        </div>
                        <div class="upload-constraints">(Tối đa: 5 hình, mỗi hình dưới 5MB, định dạng: JPG, PNG, GIF)</div>
                        <div class="preview-container" id="image-preview-container"></div>
                    </div>
                    
                    <!-- Video Upload Section -->
                    <div class="upload-section">
                        <div class="upload-section-title">Đăng tải video</div>
                        <div class="file-upload" id="video-upload-area">
                            <i class="fas fa-video text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Kéo thả video vào đây hoặc nhấn để chọn</p>
                            <input type="file" id="video-upload" accept="video/*">
                        </div>
                        <div class="upload-constraints">(Tối đa: 1 video, dưới 20MB, định dạng: MP4, MOV)</div>
                        <div class="preview-container" id="video-preview-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Section 4: Refund Information -->
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin hoàn tiền</h2>
                <div class="info-box">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="mb-3">
                                <label class="block text-sm text-gray-600 mb-1">Số tiền hoàn tối đa</label>
                                <div class="text-xl font-bold text-red-600">4.206.006₫</div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-sm text-gray-600 mb-1">Hoàn tiền vào</label>
                                <div class="font-medium">Ví ShopeePay</div>
                            </div>
                        </div>
                        <div>
                            <div class="mb-3">
                                <label class="block text-sm text-gray-600 mb-1">Email</label>
                                <div class="font-medium">tworipayers079@gmail.com</div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Số tiền chính hoàn tối đa</label>
                                <div class="font-medium">206.006₫</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-between mt-8">
                <button class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-comment-alt mr-2"></i> Trò chuyện
                </button>
                <button id="submit-return-request" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Hoàn thành <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Lý do và phương án tương ứng
        const solutionOptions = {
            "": "-",
            "damaged": `
                <div class="solution-option">
                    <input type="radio" name="solution" id="solution1" value="return">
                    <label for="solution1" class="flex-1">
                        <div class="font-medium">Trả hàng hoàn tiền</div>
                        <p class="text-sm text-gray-500">Bạn cần trả lại hàng để được hoàn tiền</p>
                    </label>
                </div>
            `,
            "missing": `
                <div class="solution-option">
                    <input type="radio" name="solution" id="solution1" value="return">
                    <label for="solution1" class="flex-1">
                        <div class="font-medium">Trả hàng hoàn tiền</div>
                        <p class="text-sm text-gray-500">Bạn cần trả lại hàng để được hoàn tiền</p>
                    </label>
                </div>
                <div class="solution-option">
                    <input type="radio" name="solution" id="solution2" value="refund">
                    <label for="solution2" class="flex-1">
                        <div class="font-medium">Hoàn tiền ngay (không trả hàng)</div>
                        <p class="text-sm text-gray-500">Chúng tôi sẽ xem xét yêu cầu của bạn trong 3-5 ngày</p>
                    </label>
                </div>
            `,
            "wrong": `
                <div class="solution-option selected">
                    <input type="radio" name="solution" id="solution3" value="return" checked disabled>
                    <label for="solution3" class="flex-1">
                        <div class="font-medium">Trả hàng và Hoàn tiền</div>
                        <p class="text-sm text-gray-500">Bạn cần trả lại hàng để được hoàn tiền</p>
                    </label>
                </div>
            `,
            "expired": `
                <div class="solution-option selected">
                    <input type="radio" name="solution" id="solution4" value="refund" checked disabled>
                    <label for="solution4" class="flex-1">
                        <div class="font-medium">Hoàn tiền ngay (không trả hàng)</div>
                        <p class="text-sm text-gray-500">Chúng tôi sẽ hoàn tiền ngay sau khi xác nhận</p>
                    </label>
                </div>
            `,
            "other": `
                <div class="solution-option">
                    <input type="radio" name="solution" id="solution5" value="return">
                    <label for="solution5" class="flex-1">
                        <div class="font-medium">Trả hàng hoàn tiền</div>
                        <p class="text-sm text-gray-500">Bạn cần trả lại hàng để được hoàn tiền</p>
                    </label>
                </div>
                <div class="solution-option">
                    <input type="radio" name="solution" id="solution6" value="refund">
                    <label for="solution6" class="flex-1">
                        <div class="font-medium">Hoàn tiền ngay (không trả hàng)</div>
                        <p class="text-sm text-gray-500">Chúng tôi sẽ xem xét yêu cầu của bạn trong 3-5 ngày</p>
                    </label>
                </div>
            `
        };

        // DOM Elements
        const reasonCards = document.querySelectorAll('.reason-card');
        const reasonSelect = document.getElementById('reason-select');
        const solutionSection = document.getElementById('solution-section');
        const imageUpload = document.getElementById('image-upload');
        const videoUpload = document.getElementById('video-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const videoPreviewContainer = document.getElementById('video-preview-container');
        const imageUploadArea = document.getElementById('image-upload-area');
        const videoUploadArea = document.getElementById('video-upload-area');
        const submitBtn = document.getElementById('submit-return-request');

        // Arrays to store uploaded files
        let uploadedImages = [];
        let uploadedVideos = [];

        // Function to update solution options based on reason
        function updateSolutionOptions(reason) {
            solutionSection.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Phương án</label>
                ${solutionOptions[reason] || '<div class="text-gray-500 italic">Vui lòng chọn lý do để xem phương án</div>'}
            `;
            
            // Attach event listeners to solution options
            document.querySelectorAll('.solution-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.solution-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                    }
                });
            });
        }

        // Event listener for reason select
        reasonSelect.addEventListener('change', function() {
            updateSolutionOptions(this.value);
        });

        // Event listener for reason cards
        reasonCards.forEach(card => {
            card.addEventListener('click', function() {
                reasonCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                const reason = this.dataset.reason;
                reasonSelect.value = reason;
                updateSolutionOptions(reason);
            });
        });

        // Handle image upload
        imageUpload.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const maxFiles = 5;
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            
            // Check file count
            if (files.length + uploadedImages.length > maxFiles) {
                alert(`Bạn chỉ được tải lên tối đa ${maxFiles} hình ảnh`);
                return;
            }
            
            files.forEach(file => {
                // Check file type
                if (!allowedTypes.includes(file.type)) {
                    alert(`File ${file.name} không phải là định dạng hình ảnh hợp lệ (JPG, PNG, GIF)`);
                    return;
                }
                
                // Check file size
                if (file.size > maxSize) {
                    alert(`File ${file.name} vượt quá kích thước cho phép (5MB)`);
                    return;
                }
                
                // Add to uploaded images
                uploadedImages.push(file);
                
                // Create preview
                createImagePreview(file);
            });
            
            // Reset input
            imageUpload.value = '';
        });

        // Handle video upload
        videoUpload.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const maxSize = 20 * 1024 * 1024; // 20MB
            const allowedTypes = ['video/mp4', 'video/quicktime'];
            
            // Check if already have a video
            if (uploadedVideos.length > 0) {
                alert('Bạn chỉ được tải lên 1 video');
                videoUpload.value = '';
                return;
            }
            
            files.forEach(file => {
                // Check file type
                if (!allowedTypes.includes(file.type)) {
                    alert(`File ${file.name} không phải là định dạng video hợp lệ (MP4, MOV)`);
                    return;
                }
                
                // Check file size
                if (file.size > maxSize) {
                    alert(`File ${file.name} vượt quá kích thước cho phép (20MB)`);
                    return;
                }
                
                // Add to uploaded videos
                uploadedVideos.push(file);
                
                // Create preview
                createVideoPreview(file);
            });
            
            // Reset input
            videoUpload.value = '';
        });

        // Create image preview
        function createImagePreview(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="remove-btn" data-type="image" data-name="${file.name}">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                imagePreviewContainer.appendChild(previewItem);
                
                // Add remove event
                const removeBtn = previewItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    removeFile('image', file.name);
                    previewItem.remove();
                });
            };
            
            reader.readAsDataURL(file);
        }

        // Create video preview
        function createVideoPreview(file) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            previewItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-file-video"></i>
                </div>
                <div class="remove-btn" data-type="video" data-name="${file.name}">
                    <i class="fas fa-times"></i>
                </div>
                <div class="file-info">
                    <div>${file.name}</div>
                    <div>${formatFileSize(file.size)}</div>
                </div>
            `;
            
            videoPreviewContainer.appendChild(previewItem);
            
            // Add remove event
            const removeBtn = previewItem.querySelector('.remove-btn');
            removeBtn.addEventListener('click', function() {
                removeFile('video', file.name);
                previewItem.remove();
            });
        }

        // Remove file from arrays
        function removeFile(type, fileName) {
            if (type === 'image') {
                uploadedImages = uploadedImages.filter(file => file.name !== fileName);
            } else if (type === 'video') {
                uploadedVideos = uploadedVideos.filter(file => file.name !== fileName);
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Submit return request
        submitBtn.addEventListener('click', function() {
            const reason = reasonSelect.value;
            const solution = document.querySelector('input[name="solution"]:checked')?.value;
            const description = document.querySelector('textarea').value;
            
            // Basic validation
            if (!reason) {
                alert('Vui lòng chọn lý do trả hàng');
                return;
            }
            
            if (!solution) {
                alert('Vui lòng chọn phương án giải quyết');
                return;
            }
            
            if (!description) {
                alert('Vui lòng mô tả chi tiết vấn đề');
                return;
            }
            
            // Prepare form data for Laravel
            const formData = new FormData();
            formData.append('reason', reason);
            formData.append('solution', solution);
            formData.append('description', description);
            
            // Add uploaded files
            uploadedImages.forEach((file, index) => {
                formData.append(`images[${index}]`, file);
            });
            
            uploadedVideos.forEach((file, index) => {
                formData.append(`videos[${index}]`, file);
            });
            
            // Get order ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            if (orderId) {
                formData.append('order_id', orderId);
            }
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
            submitBtn.disabled = true;
            
            // In real Laravel app, you would use:
            // fetch("{{ route('returns.submit') }}", {
            //   method: 'POST',
            //   body: formData,
            //   headers: {
            //     'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
            //   }
            // })
            
            // For demo purposes
            setTimeout(() => {
                alert('Yêu cầu trả hàng đã được gửi thành công! Chúng tôi sẽ xử lý trong 3-5 ngày làm việc.');
                submitBtn.innerHTML = 'Hoàn thành <i class="fas fa-arrow-right ml-2"></i>';
                submitBtn.disabled = false;
            }, 1500);
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            updateSolutionOptions('');
            
            // Check if we have an order ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            
            if (orderId) {
                console.log(`Processing return request for order: ${orderId}`);
                // In real app, you would fetch order details from API
                // fetch(`/api/orders/${orderId}`)
                //   .then(response => response.json())
                //   .then(data => populateOrderDetails(data));
            }
            
            // Add drag and drop events for images
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                imageUploadArea.classList.add('highlight');
            }
            
            function unhighlight() {
                imageUploadArea.classList.remove('highlight');
            }
            
            imageUploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                imageUpload.files = files;
                const event = new Event('change', { bubbles: true });
                imageUpload.dispatchEvent(event);
            }
            
            // Add drag and drop events for videos
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                videoUploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                videoUploadArea.addEventListener(eventName, highlightVideo, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                videoUploadArea.addEventListener(eventName, unhighlightVideo, false);
            });
            
            function highlightVideo() {
                videoUploadArea.classList.add('highlight');
            }
            
            function unhighlightVideo() {
                videoUploadArea.classList.remove('highlight');
            }
            
            videoUploadArea.addEventListener('drop', handleDropVideo, false);
            
            function handleDropVideo(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                videoUpload.files = files;
                const event = new Event('change', { bubbles: true });
                videoUpload.dispatchEvent(event);
            }
        });

            // Hàm gửi chiều cao về trang chủ
        function sendHeightToParent() {
            const height = Math.max(
                document.body.scrollHeight,
                document.body.offsetHeight,
                document.documentElement.scrollHeight,
                document.documentElement.offsetHeight
            );
            
            // Gửi chiều cao về trang chủ
            window.parent.postMessage({
                type: 'resize',
                height: height
            }, '*');
        }

        // Sử dụng requestAnimationFrame để giới hạn tần suất gửi
        let lastSentHeight = 0;
        function throttledSendHeight() {
            const currentHeight = Math.max(
                document.body.scrollHeight,
                document.documentElement.scrollHeight
            );
            
            // Chỉ gửi nếu chiều cao thay đổi đáng kể
            if (Math.abs(currentHeight - lastSentHeight) > 50) {
                sendHeightToParent();
                lastSentHeight = currentHeight;
            }
            requestAnimationFrame(throttledSendHeight);
        }

        // Bắt đầu theo dõi
        throttledSendHeight();

        // Gửi chiều cao khi trang tải xong
        window.addEventListener('load', () => {
            setTimeout(sendHeightToParent, 300);
        });

        // Trả lời khi nhận được yêu cầu từ trang chủ
        window.addEventListener('message', (event) => {
            if (event.data === 'getHeight') {
                throttledSendHeight();
            }
        });

        // Theo dõi thay đổi nội dung với MutationObserver
        const observer = new MutationObserver(() => {
            throttledSendHeight();
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: false,
            characterData: false
        });
    </script>
</body>
</html>